---
name: stm32-cubemx-ioc-cli
description: Use when STM32 tasks involve pin/peripheral/DMA/NVIC/clock configuration changes, CubeMX regeneration, or IOC-to-code consistency checks. Enforces IOC as single source of truth and uses STM32CubeMX CLI headless flow.
---

# STM32CubeMX IOC CLI Workflow

Use this skill for STM32 projects generated by CubeMX when configuration must be changed safely and reproducibly.

## Hard Rules

1. `.ioc` is the single source of truth for pin/peripheral/DMA/NVIC/clock configuration.
2. Do not hand-edit generated peripheral init code to simulate configuration changes.
3. For generated files, write business logic only in `USER CODE BEGIN/END` regions.
4. Use HAL APIs by default; avoid direct register writes unless explicitly requested and justified.
5. Follow this fixed order: edit `.ioc` -> regenerate via CubeMX CLI -> build verify -> diff check -> report.

## Required Inputs

- MCU/model
- Project root absolute path
- IOC absolute path
- Desired pin/peripheral changes
- DMA/IRQ requirements
- Interface parameters (baud rate, mode, sample trigger, etc.)
- Generation mode: `generate code` or `project generate`
- Build command/preset

## Execution Steps

1. Baseline scan (`.ioc` + code):
   - Collect `Mcu.IPx`, `Mcu.IPNb`, `Mcu.Pinx`, `Mcu.PinsNb`
   - Collect `Dma.*`, `Dma.RequestsNb`
   - Collect `NVIC.*`
   - Collect `ProjectManager.functionlistsort`
   - Collect target peripheral keys (USART/ADC/TIM/I2C/GPIO)

2. Update `.ioc` only:
   - Apply requested key changes.
   - Keep counters/order fields consistent.
   - Do not patch generated init files as a substitute.

3. Create CLI script (absolute paths only):
   - Start with:
     - `config load /abs/path/project.ioc`
   - Choose generation mode by output layout:
     - If `generate code /abs/path/project_root` updates the build-consumed tree, use it.
     - If it generates into a non-consumed layout (for example `Src/Inc` while build uses `Core/Src`), switch to:
       - `project toolchain CMake`
       - `project name <project>`
       - `project generate`
   - End with `exit`.

4. Run CubeMX headless:
   - `/abs/path/to/STM32CubeMX -q /abs/path/to/cube_headless.txt`
   - Confirm success markers (`Generated code`, `OK`, `Bye bye`).

5. Verify build:
   - Use project build flow (for example `cmake --preset Debug` and `cmake --build build/Debug`).
   - Do not claim completion without build verification unless toolchain is unavailable; if unavailable, report that explicitly.

6. Inspect diffs:
   - Ensure only expected files changed.
   - Validate generated init order and handler generation.

7. Report:
   - IOC keys changed (exact key/value)
   - CLI script content
   - Executed generation/build commands
   - Verification result
   - Risks and rollback

## Expected Output Checklist

- Requirement interpretation
- Impact scope (`.ioc`, generated code, `USER CODE`)
- Concrete IOC modifications
- CLI script and commands
- Build validation commands/results
- Risk list + rollback point

## Failure Triage

- CLI ran but no generation:
  - check absolute paths, `config load` target, file permissions, CubeMX binary path.
- Peripheral not generated:
  - check `Mcu.IPx`, `Mcu.IPNb`, pin signal keys, `functionlistsort`.
- DMA/IRQ not working:
  - check peripheral DMA flags, `Dma.Request*`, `Dma.RequestsNb`, matching `NVIC.*`.

## References

- IOC key checklist: `references/ioc-key-checklist.md`
- CLI templates: `references/cli-script-templates.md`
